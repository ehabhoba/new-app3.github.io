<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>طلب خدمة بحث مخصص</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      transition: all 0.3s ease;
    }
    .ltr {
      font-family: 'Inter', sans-serif;
      direction: ltr;
      text-align: left;
    }
    .rtl {
      font-family: 'Cairo', sans-serif;
      direction: rtl;
      text-align: right;
    }
    .error {
      border-color: #ef4444 !important;
    }
    .error-message {
      color: #ef4444;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }
    .tooltip {
      position: relative;
      display: inline-block;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      right: 50%;
      transform: translateX(50%);
      opacity: 0;
      transition: opacity 0.3s;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4 rtl">
  <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
    <div class="flex justify-between items-center mb-6">
      <h1 id="title" class="text-2xl font-bold text-gray-800">طلب خدمة بحث مخصص</h1>
      <button id="langToggle" class="text-sm text-blue-600 hover:underline">English</button>
    </div>

    <div class="space-y-5">
      <div>
        <label for="studentName" id="studentNameLabel" class="block text-sm font-medium text-gray-700 mb-1">اسم الطالب:</label>
        <div class="relative">
          <input type="text" id="studentName" required placeholder="أدخل اسمك" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 pl-10">
          <svg class="absolute right-3 top-3 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
        </div>
        <p id="studentNameError" class="error-message hidden">اكتب اسمك لو سمحت!</p>
      </div>

      <div>
        <label for="studentPhone" id="studentPhoneLabel" class="block text-sm font-medium text-gray-700 mb-1">رقم الهاتف:</label>
        <div class="relative">
          <input type="tel" id="studentPhone" required placeholder="أدخل رقم هاتفك" pattern="[0-9]{10,15}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 pl-10">
          <svg class="absolute right-3 top-3 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.5 0a9 9 0 019 9v1.5m-3-6.5v6.5"></path>
          </svg>
        </div>
        <p id="studentPhoneError" class="error-message hidden">رقم الهاتف لازم يكون صحيح!</p>
      </div>

      <div>
        <label for="researchTitle" id="researchTitleLabel" class="block text-sm font-medium text-gray-700 mb-1">عنوان البحث:</label>
        <div class="relative">
          <input type="text" id="researchTitle" required placeholder="أدخل عنوان البحث" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 pl-10">
          <svg class="absolute right-3 top-3 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 006 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"></path>
          </svg>
        </div>
        <p id="researchTitleError" class="error-message hidden">اكتب عنوان البحث لو سمحت!</p>
      </div>

      <div>
        <label for="stage" id="stageLabel" class="block text-sm font-medium text-gray-700 mb-1">المرحلة الدراسية:</label>
        <div class="relative">
          <select id="stage" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 pl-10" required>
            <option value="">اختر المرحلة</option>
            <option value="primary">الابتدائي</option>
            <option value="preparatory">الإعدادي</option>
            <option value="secondary">الثانوي</option>
            <option value="university">الجامعي</option>
            <option value="postgraduate">الدراسات العليا</option>
          </select>
          <svg class="absolute right-3 top-3 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z"></path>
          </svg>
        </div>
        <p id="stageError" class="error-message hidden">اختار المرحلة لو سمحت!</p>
      </div>

      <div>
        <label for="researchType" id="researchTypeLabel" class="block text-sm font-medium text-gray-700 mb-1">نوع البحث:</label>
        <div class="relative">
          <select id="researchType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 pl-10" required>
            <option value="">اختر نوع البحث</option>
            <option value="school_report">تقرير مدرسي</option>
            <option value="secondary_research">بحث ثانوي</option>
            <option value="university_research">بحث جامعي</option>
            <option value="thesis">أطروحة</option>
          </select>
          <svg class="absolute right-3 top-3 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 006 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"></path>
          </svg>
        </div>
        <div class="tooltip mt-1">
          <span class="text-xs text-gray-500">اضغط لمعرفة الفرق بين أنواع البحث</span>
          <span class="tooltiptext">
            - تقرير مدرسي: للمشاريع البسيطة (ابتدائي/إعدادي)<br>
            - بحث ثانوي: للطلاب في الثانوية<br>
            - بحث جامعي: للطلاب الجامعيين<br>
            - أطروحة: للدراسات العليا (ماجستير/دكتوراه)
          </span>
        </div>
        <p id="researchTypeError" class="error-message hidden">اختار نوع البحث لو سمحت!</p>
      </div>

      <div>
        <label for="pages" id="pagesLabel" class="block text-sm font-medium text-gray-700 mb-1">عدد الأوراق:</label>
        <div class="relative">
          <input type="number" id="pages" min="1" required placeholder="أدخل عدد الأوراق" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 pl-10">
          <svg class="absolute right-3 top-3 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
        </div>
        <p id="pagesError" class="error-message hidden">عدد الأوراق لازم يكون أكبر من 0!</p>
      </div>

      <div>
        <label for="deliveryDate" id="deliveryDateLabel" class="block text-sm font-medium text-gray-700 mb-1">تاريخ التسليم:</label>
        <div class="relative">
          <input type="date" id="deliveryDate" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 pl-10">
          <svg class="absolute right-3 top-3 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
        </div>
        <p id="deliveryDateError" class="error-message hidden">اختار تاريخ التسليم لو سمحت!</p>
      </div>

      <div>
        <label for="language" id="languageLabel" class="block text-sm font-medium text-gray-700 mb-1">اللغة:</label>
        <div class="relative">
          <select id="language" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 pl-10" required>
            <option value="arabic">العربية</option>
            <option value="english">الإنجليزية</option>
          </select>
          <svg class="absolute right-3 top-3 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.5 0a9 9 0 019 9v1.5m-3-6.5v6.5"></path>
          </svg>
        </div>
      </div>

      <button onclick="calculateCost()" id="calculateBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition">احسب التكلفة</button>
      <div id="result" class="text-center text-lg font-semibold text-gray-800"></div>
      <button id="sendWhatsApp" onclick="previewOrder()" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition hidden">إرسال الطلب عبر WhatsApp</button>
    </div>

    <div id="orderPreview" class="hidden mt-6 p-4 bg-gray-100 rounded-lg">
      <h2 id="previewTitle" class="text-lg font-semibold mb-2">معاينة الطلب</h2>
      <p id="previewDetails"></p>
      <div class="flex justify-between mt-4">
        <button onclick="submitToGoogleSheets()" id="confirmBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">تأكيد الإرسال</button>
        <button onclick="closePreview()" id="cancelBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إلغاء</button>
      </div>
    </div>
  </div>

  <script>
    // Language toggle
    const translations = {
      ar: {
        title: 'طلب خدمة بحث مخصص',
        studentNameLabel: 'اسم الطَالب:',
        studentNamePlaceholder: 'أدخل اسمك',
        studentPhoneLabel: 'رقم الهاتف:',
        studentPhonePlaceholder: 'أدخل رقم هاتفك',
        researchTitleLabel: 'عنوان البحث:',
        researchTitlePlaceholder: 'أدخل عنوان البحث',
        stageLabel: 'المرحلة الدراسية:',
        stagePlaceholder: 'اختر المرحلة',
        researchTypeLabel: 'نوع البحث:',
        researchTypePlaceholder: 'اختر نوع البحث',
        pagesLabel: 'عدد الأوراق:',
        pagesPlaceholder: 'أدخل عدد الأوراق',
        deliveryDateLabel: 'تاريخ التَسليم:',
        languageLabel: 'اللغة:',
        calculateBtn: 'احسب التَكلفة',
        sendWhatsApp: 'إرسال الطَلب عبر WhatsApp',
        studentNameError: 'اكتب اسمك لو سمحت!',
        studentPhoneError: 'رقم الهاتف لازم يكون صحيح!',
        researchTitleError: 'اكتب عنوان البحث لو سمحت!',
        stageError: 'اختار المرحلة لو سمحت!',
        researchTypeError: 'اختار نوع البحث لو سمحت!',
        pagesError: 'عدد الأوراق لازم يكون أكبر من 0!',
        deliveryDateError: 'اختار تاريخ التَسليم لو سمحت!',
        previewTitle: 'معاينة الطَلب',
        confirmBtn: 'تأكيد الإرسال',
        cancelBtn: 'إلغاء',
        langToggle: 'English'
      },
      en: {
        title: 'Custom Research Request',
        studentNameLabel: 'Student Name:',
        studentNamePlaceholder: 'Enter your name',
        studentPhoneLabel: 'Phone Number:',
        studentPhonePlaceholder: 'Enter your phone number',
        researchTitleLabel: 'Research Title:',
        researchTitlePlaceholder: 'Enter research title',
        stageLabel: 'Academic Level:',
        stagePlaceholder: 'Select level',
        researchTypeLabel: 'Research Type:',
        researchTypePlaceholder: 'Select research type',
        pagesLabel: 'Number of Pages:',
        pagesPlaceholder: 'Enter number of pages',
        deliveryDateLabel: 'Delivery Date:',
        languageLabel: 'Language:',
        calculateBtn: 'Calculate Cost',
        sendWhatsApp: 'Send Request via WhatsApp',
        studentNameError: 'Please enter your name!',
        studentPhoneError: 'Please enter a valid phone number!',
        researchTitleError: 'Please enter the research title!',
        stageError: 'Please select an academic level!',
        researchTypeError: 'Please select a research type!',
        pagesError: 'Number of pages must be greater than 0!',
        deliveryDateError: 'Please select a delivery date!',
        previewTitle: 'Order Preview',
        confirmBtn: 'Confirm Send',
        cancelBtn: 'Cancel',
        langToggle: 'العربية'
      }
    };

    let currentLang = 'ar';
    const langToggleBtn = document.getElementById('langToggle');
    langToggleBtn.addEventListener('click', () => {
      currentLang = currentLang === 'ar' ? 'en' : 'ar';
      updateLanguage();
    });

    function updateLanguage() {
      const t = translations[currentLang];
      document.getElementById('title').textContent = t.title;
      document.getElementById('studentNameLabel').textContent = t.studentNameLabel;
      document.getElementById('studentPhoneLabel').textContent = t.studentPhoneLabel;
      document.getElementById('researchTitleLabel').textContent = t.researchTitleLabel;
      document.getElementById('stageLabel').textContent = t.stageLabel;
      document.getElementById('researchTypeLabel').textContent = t.researchTypeLabel;
      document.getElementById('pagesLabel').textContent = t.pagesLabel;
      document.getElementById('deliveryDateLabel').textContent = t.deliveryDateLabel;
      document.getElementById('languageLabel').textContent = t.languageLabel;
      document.getElementById('calculateBtn').textContent = t.calculateBtn;
      document.getElementById('sendWhatsApp').textContent = t.sendWhatsApp;
      document.getElementById('previewTitle').textContent = t.previewTitle;
      document.getElementById('confirmBtn').textContent = t.confirmBtn;
      document.getElementById('cancelBtn').textContent = t.cancelBtn;
      document.getElementById('langToggle').textContent = t.langToggle;

      document.getElementById('studentName').placeholder = t.studentNamePlaceholder;
      document.getElementById('studentPhone').placeholder = t.studentPhonePlaceholder;
      document.getElementById('researchTitle').placeholder = t.researchTitlePlaceholder;
      document.getElementById('stage').options[0].textContent = t.stagePlaceholder;
      document.getElementById('researchType').options[0].textContent = t.researchTypePlaceholder;
      document.getElementById('pages').placeholder = t.pagesPlaceholder;
      document.body.classList.remove(currentLang === 'ar' ? 'ltr' : 'rtl');
      document.body.classList.add(currentLang === 'ar' ? 'rtl' : 'ltr');
    }

    // Form validation
    function validateForm() {
      let isValid = true;
      const studentName = document.getElementById('studentName');
      const studentPhone = document.getElementById('studentPhone');
      const researchTitle = document.getElementById('researchTitle');
      const stage = document.getElementById('stage');
      const researchType = document.getElementById('researchType');
      const pages = document.getElementById('pages');
      const deliveryDate = document.getElementById('deliveryDate');
      const t = translations[currentLang];

      // Reset errors
      studentName.classList.remove('error');
      studentPhone.classList.remove('error');
      researchTitle.classList.remove('error');
      stage.classList.remove('error');
      researchType.classList.remove('error');
      pages.classList.remove('error');
      deliveryDate.classList.remove('error');
      document.getElementById('studentNameError').classList.add('hidden');
      document.getElementById('studentPhoneError').classList.add('hidden');
      document.getElementById('researchTitleError').classList.add('hidden');
      document.getElementById('stageError').classList.add('hidden');
      document.getElementById('researchTypeError').classList.add('hidden');
      document.getElementById('pagesError').classList.add('hidden');
      document.getElementById('deliveryDateError').classList.add('hidden');

      // Validate student name
      if (!studentName.value.trim()) {
        studentName.classList.add('error');
        document.getElementById('studentNameError').textContent = t.studentNameError;
        document.getElementById('studentNameError').classList.remove('hidden');
        isValid = false;
      }

      // Validate student phone
      const phonePattern = /^[0-9]{10,15}$/;
      if (!phonePattern.test(studentPhone.value.trim())) {
        studentPhone.classList.add('error');
        document.getElementById('studentPhoneError').textContent = t.studentPhoneError;
        document.getElementById('studentPhoneError').classList.remove('hidden');
        isValid = false;
      }

      // Validate research title
      if (!researchTitle.value.trim()) {
        researchTitle.classList.add('error');
        document.getElementById('researchTitleError').textContent = t.researchTitleError;
        document.getElementById('researchTitleError').classList.remove('hidden');
        isValid = false;
      }

      // Validate stage
      if (!stage.value) {
        stage.classList.add('error');
        document.getElementById('stageError').textContent = t.stageError;
        document.getElementById('stageError').classList.remove('hidden');
        isValid = false;
      }

      // Validate research type
      if (!researchType.value) {
        researchType.classList.add('error');
        document.getElementById('researchTypeError').textContent = t.researchTypeError;
        document.getElementById('researchTypeError').classList.remove('hidden');
        isValid = false;
      }

      // Validate pages
      const pagesValue = parseInt(pages.value);
      if (!pagesValue || pagesValue < 1) {
        pages.classList.add('error');
        document.getElementById('pagesError').textContent = t.pagesError;
        document.getElementById('pagesError').classList.remove('hidden');
        isValid = false;
      }

      // Validate delivery date
      const today = new Date().toISOString().split('T')[0];
      if (!deliveryDate.value || deliveryDate.value < today) {
        deliveryDate.classList.add('error');
        document.getElementById('deliveryDateError').textContent = t.deliveryDateError;
        document.getElementById('deliveryDateError').classList.remove('hidden');
        isValid = false;
      }

      return isValid;
    }

    let calculatedCost = 0;
    let orderDetails = {};

    function calculateCost() {
      if (!validateForm()) {
        document.getElementById('result').innerHTML = `<span class="text-red-500">${translations[currentLang].pagesError}</span>`;
        document.getElementById('sendWhatsApp').classList.add('hidden');
        return;
      }

      const studentName = document.getElementById('studentName').value.trim();
      const studentPhone = document.getElementById('studentPhone').value.trim();
      const researchTitle = document.getElementById('researchTitle').value.trim();
      const stage = document.getElementById('stage').value;
      const researchType = document.getElementById('researchType').value;
      const pages = parseInt(document.getElementById('pages').value);
      const deliveryDate = document.getElementById('deliveryDate').value;
      const language = document.getElementById('language').value;

      // Calculate cost
      const basePricePerPage = 50;
      let typeMultiplier = 1;
      if (researchType === 'secondary_research') typeMultiplier = 1.2;
      else if (researchType === 'university_research') typeMultiplier = 1.5;
      else if (researchType === 'thesis') typeMultiplier = 2;

      calculatedCost = pages * basePricePerPage * typeMultiplier;
      if (language === 'english') calculatedCost *= 1.2;

      // Display result
      document.getElementById('result').innerHTML = `${translations[currentLang].calculateBtn}: ${calculatedCost.toFixed(2)} EGP`;
      document.getElementById('sendWhatsApp').classList.remove('hidden');

      // Store order details
      orderDetails = {
        studentName,
        studentPhone,
        researchTitle,
        stage,
        researchType,
        pages,
        deliveryDate,
        language,
        cost: calculatedCost,
        timestamp: new Date().toISOString()
      };
    }

    function previewOrder() {
      const { studentName, studentPhone, researchTitle, stage, researchType, pages, deliveryDate, language, cost } = orderDetails;
      const stageText = document.querySelector(`#stage option[value="${stage}"]`).textContent;
      const researchTypeText = document.querySelector(`#researchType option[value="${researchType}"]`).textContent;
      const languageText = document.querySelector(`#language option[value="${language}"]`).textContent;

      const orderId = `ORD-${Date.now()}`;
      const previewText = `
        ${currentLang === 'ar' ? 'معرف الطَلب' : 'Order ID'}: ${orderId}<br>
        ${translations[currentLang].studentNameLabel} ${studentName}<br>
        ${translations[currentLang].studentPhoneLabel} ${studentPhone}<br>
        ${translations[currentLang].researchTitleLabel} ${researchTitle}<br>
        ${translations[currentLang].stageLabel} ${stageText}<br>
        ${translations[currentLang].researchTypeLabel} ${researchTypeText}<br>
        ${translations[currentLang].pagesLabel} ${pages}<br>
        ${translations[currentLang].deliveryDateLabel} ${deliveryDate}<br>
        ${translations[currentLang].languageLabel} ${languageText}<br>
        ${translations[currentLang].calculateBtn}: ${cost.toFixed(2)} EGP
      `;

      document.getElementById('previewDetails').innerHTML = previewText;
      document.getElementById('orderPreview').classList.remove('hidden');
    }

    function closePreview() {
      document.getElementById('orderPreview').classList.add('hidden');
    }

    async function submitToGoogleSheets() {
      const { studentName, studentPhone, researchTitle, stage, researchType, pages, deliveryDate, language, cost } = orderDetails;
      const stageText = document.querySelector(`#stage option[value="${stage}"]`).textContent;
      const researchTypeText = document.querySelector(`#researchType option[value="${researchType}"]`).textContent;

      const data = {
        studentName,
        studentPhone,
        researchTitle,
        pages,
        deliveryDate,
        stage: stageText,
        researchType: researchTypeText,
        cost: cost.toFixed(2)
      };

      try {
        const response = await fetch('https://script.google.com/macros/s/AKfycbzDjJrsPCzlz-18OHjcCEeKS-jU_iq8DL5SUhWBiQtjHb-165TQ68F9fB-9uUuIjXROKA/exec', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.status === 'success') {
          // Send to WhatsApp
          sendToWhatsApp();
          alert(currentLang === 'ar' ? 'تم إرسال الطَلب بنجاح إلى Google Sheets وWhatsApp!' : 'Order successfully sent to Google Sheets and WhatsApp!');
        } else {
          alert(currentLang === 'ar' ? 'حدث خطأ أثناء إرسال الطَلب إلى Google Sheets: ' + result.message : 'Error sending order to Google Sheets: ' + result.message);
        }
      } catch (error) {
        alert(currentLang === 'ar' ? 'حدث خطأ أثناء الاتَصال بـ Google Sheets: ' + error.message : 'Error connecting to Google Sheets: ' + error.message);
      }
    }

    function sendToWhatsApp() {
      const { studentName, studentPhone, researchTitle, stage, researchType, pages, deliveryDate, language, cost } = orderDetails;
      const orderId = `ORD-${Date.now()}`;
      const stageText = document.querySelector(`#stage option[value="${stage}"]`).textContent;
      const researchTypeText = document.querySelector(`#researchType option[value="${researchType}"]`).textContent;
      const languageText = document.querySelector(`#language option[value="${language}"]`).textContent;

      const message = `${currentLang === 'ar' ? 'طلب بحث مخصص' : 'Custom Research Request'}:\n` +
                      `${currentLang === 'ar' ? 'معرف الطَلب' : 'Order ID'}: ${orderId}\n` +
                      `${translations[currentLang].studentNameLabel} ${studentName}\n` +
                      `${translations[currentLang].studentPhoneLabel} ${studentPhone}\n` +
                      `${translations[currentLang].researchTitleLabel} ${researchTitle}\n` +
                      `${translations[currentLang].stageLabel} ${stageText}\n` +
                      `${translations[currentLang].researchTypeLabel} ${researchTypeText}\n` +
                      `${translations[currentLang].pagesLabel} ${pages}\n` +
                      `${translations[currentLang].deliveryDateLabel} ${deliveryDate}\n` +
                      `${translations[currentLang].languageLabel} ${languageText}\n` +
                      `${translations[currentLang].calculateBtn}: ${cost.toFixed(2)} EGP`;

      const phoneNumber = '201022679250';
      const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');

      // Save order to localStorage
      const orders = JSON.parse(localStorage.getItem('orders') || '[]');
      orders.push({ ...orderDetails, orderId });
      localStorage.setItem('orders', JSON.stringify(orders));

      // Reset form
      document.getElementById('studentName').value = '';
      document.getElementById('studentPhone').value = '';
      document.getElementById('researchTitle').value = '';
      document.getElementById('stage').value = '';
      document.getElementById('researchType').value = '';
      document.getElementById('pages').value = '';
      document.getElementById('deliveryDate').value = '';
      document.getElementById('language').value = 'arabic';
      document.getElementById('result').innerHTML = '';
      document.getElementById('sendWhatsApp').classList.add('hidden');
      document.getElementById('orderPreview').classList.add('hidden');
    }
  </script>
</body>
</html>